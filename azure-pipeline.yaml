trigger:
  - master

#variables:
#  - name: PoolName
#    value: 'mycomputeragent'
#    readonly: true
#  - name: AgentName
#    value: 'CentOS9'
#    readonly: true
#
#pool: 
#  name: $(PoolName)
#  demands:
#    - agent.name -equals $(AgentName)
pool:
  vmImage: 'ubuntu-latest'


stages:
  - stage: Build
    jobs:
      - job: Build
        displayName: Build and push Docker
        steps:
        
          - task: DownloadSecureFile@1
            name: configFile
            inputs:
              secureFile: 'config.json'

          - script: |
              echo Installing $(configFile.secureFilePath) to the trusted CA directory...
              sudo chown root:root $(configFile.secureFilePath)
              sudo chmod a+r $(configFile.secureFilePath)
              sudo ln -s -t /etc/ssl/certs/ $(configFile.secureFilePath)

          - task: Docker@2
            inputs:
              containerRegistry: 'viodid-docker-hub'
              repository: 'calat33'
              command: 'build'
              Dockerfile: '**/Dockerfile'
              arguments: '--build-arg="config_file=$(configFile.secureFilePath)" --build-arg="config_dir=$(Agent.TempDirectory)"'
              
          - task: Docker@2
            inputs:
              containerRegistry: 'viodid-docker-hub'
              repository: 'calat33'
              command: 'push'
  - stage: Deploy
    jobs:
      - job: Deploy
        steps:
        - script: echo "deploying"
  - stage: Release
    jobs:
      - deployment: Release
        environment: 'my-environment'
        strategy:
          runOnce:
            deploy:
              steps:
              - script: echo "releasing"
